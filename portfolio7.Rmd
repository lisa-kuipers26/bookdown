# Databases


Om wat functie van de databse te laten zijn worden er verschillende datasets ingeladen. Hieronder staat de de code voor he tinladen, waarbij de data van de dengue en flu google trends tidy gemaakt worden door de landnamen in één kolom te zetten. Voorderest worden ook de datum opgesplitst in dagen, maanden en jaren zodat deze later beter samengevoegd kunnen worden met de gapminder data.
```{r data_laden, eval=FALSE}
library(dslabs)
library(tidyverse)

#laden van gapminder
gapminder_df <- gapminder %>% as.data.frame()


#tidy maken van data functie
tidy_func <- function(path){
  read_df <- read.csv(path, skip=11) %>% as.data.frame
  col_nam <- colnames(read_df)
  read_df %>% pivot_longer(cols=col_nam[-1], names_to="country", values_to=paste0("activity")) %>%
    separate(Date, into = c("year", "month","day"),convert = TRUE)
}

dengue_tidy <- tidy_func("data/dengue_data.csv")
flu_tidy <- tidy_func("data/flu_data.csv")

#opslaan als RDS
saveRDS(dengue_tidy, file = "data/dengue_tidy.rds")
saveRDS(flu_tidy, file = "data/flu_tidy.rds")
saveRDS(gapminder_df, file = "data/gapminder.rds")

#opslaan als CSV
write.csv(gapminder_df,"data/gapminder.csv")
write.csv(dengue_tidy,"data/dengue_tidy.csv")
write.csv(flu_tidy,"data/flu_tidy.csv")

```

Er moet een database gemaakt worden om de tabellen op te slaan. Hieronder staat SQL code die ingevoerd kan worden bij het programma dBeaver (of een andere database software) voor het creëren van een database.
```{sql opzetten database, eval=FALSE}
CREATE DATABASE workflows;
```

Om de databse te gebruiken in R wordt er een connectie aangemaakt. Met de connectie kan R code gebruikt worden voor interactie met de database. Dit is handig omdat je dan niet steeds tussen twee programma's hoeft te switchen. Via de connectie worden de verschillende tabellen ingeladen in de database
```{r database_laden, eval=FALSE}
library(DBI)

#Connectie opzetten
con <- dbConnect(RPostgres::Postgres(), 
                 dbname = "workflows", 
                 host="localhost", 
                 port="5432", 
                 user="postgres",
                 password="Datascience")

#Aanmaken van tabellen in databse
dbWriteTable(con, "flu", flu_tidy)
dbWriteTable(con, "dengue", dengue_tidy)
dbWriteTable(con, "gapminder", gapminder_df)
```

Om de gapminder wat netter te maken heb ik ervoor gekozen om alvast de landen en jaren die niet in de flu en dengue google trend data voorkomt te verwijderen. 
```{r gapminder clean, eval=FALSE}
#Jaren verwijderen die niet aanwezig zijn in flu en dengue
gapminder_minyear <- gapminder_df[gapminder_df$year >= min(flu_tidy$year), ]
gapminder_maxyear <- gapminder_minyear[gapminder_minyear$year <= max(flu_tidy$year), ]

#Landen weghalen die niet en flu en dengue aanwezig zijn
landen <- c(col_dengue[2:11], col_flu[2:30],recursive=TRUE)
gapminder_clean <- subset(gapminder_maxyear, country %in% landen)
```

De oude tabel gapminder wordt via de connectie verwijderd en de nette wordt ingevoerd
```{r, eval=FALSE}
#Oude tabel verwijderen en nieuwe tabel invoegen
dbRemoveTable(con, "gapminder")
dbWriteTable(con, "gapminder", gapminder_clean)
```

De ondesrtaande code is SQL code die gebruikt is om een grote tabel te creëren waar alle data in staat van drie datasets instaat. Er worden left joins gebruikt omdat niet alle landen in beide de dengue dataset en flu dataset voorkomen. Deze informatie van bepaalde datasets kan wel interessant zijn voor het analyseren van data en wordt met de left join een NULL ingevoerd bij de missende data. Voor de rest worden alle kollomen van gapminder gekozen, de dag en maand van flu en de activity van beide flu en dengue. ook worden er joins op year, month en day gedaan. Dit is zodat ze gematched worden in de tabel en laad tijd verminderd bij het sorteren.
Bij het sorteren wordt eerst op het jaartal gesorteerd en daarna op het land om het zo overzichtelijk te houden.

```{sql join, eval=FALSE}
SELECT
gapminder.*,
flu."day",
flu."month",
flu.flu_activity,
dengue.dengue_activity
FROM
    gapminder 
LEFT JOIN flu  
  ON gapminder."year"  = flu."year" and gapminder.country = flu.country 
LEFT join dengue
	ON dengue."year" = flu."year" and dengue."month" = flu."month" and dengue."day" = flu."day" and dengue.country = flu.country 
ORDER BY gapminder."year", gapminder.country  ;
```
Deze query wordt uitgevoerd in het programma beaver, hieronder een foto van het dashboard

FOTO !

Door de volgende tekst toe te voegen boven bovenstaande query wordt er een tabel gemaakt genaamd all_data
```{sql table maken, eval=FALSE}
CREATE TABLE all_data
AS
(...)


```

Op deze afbeelding is te zien dat de tabel toegevoegd is aan de database

FOTO !

```{r, eval=FALSE}
#Data uit DB ophalen
all_data <- dbReadTable(con, "all_data")
#Dataset opslaan in data 
saveRDS(all_data, file="data/all_data.rds")
#Connectie met database sluiten
dbDisconnect(con) 

```

```{r data ophalen}
#Data laden voor analyse
all_data <- readRDS("data/all_data.rds")
all_data %>% select(country,dengue_activity) %>% na.omit() %>% group_by(country) %>% summarise(mean(dengue_activity))
```


```{r data analyse life expectancy}
#Functie voor life exptancy tegen andere kolom
lifeexp_func <- function(dataset, kolom){
  means <- dataset %>%
    group_by(year) %>% 
    summarise(naam=mean(!! sym(kolom),na.rm=TRUE),
              "mean_life_expectancy"=mean(life_expectancy,na.rm=TRUE))
  
  colnames(means) <- c("year",paste0("mean_",kolom),"mean_life_expectancy")
  means
}

#Flu en dengue tegen life expactancy
mean_flu_year <- lifeexp_func(all_data,"flu_activity")
mean_dengue_year <- lifeexp_func(all_data,"dengue_activity")

```

```{r life expectancy}
mean_flu_year %>% ggplot(aes(x=year,y=mean_life_expectancy))+
    geom_line()
```

```{r flu grafiek }
mean_flu_year %>% ggplot(aes(x=year,y=mean_flu_activity))+
    geom_line()
```

```{r dengue grafiek}
mean_dengue_year %>% ggplot(aes(x=year,y=mean_dengue_activity))+
    geom_line()

```

```{r data analyse populatie}
country_data <- all_data %>% filter(year==2008) %>% 
  group_by(country) %>% 
  summarise(mean(flu_activity), max(population),max(gdp)) %>% na.omit()
colnames(country_data) <- c("country","flu_activity","population","GDP")

country_data[order(country_data$population, decreasing=TRUE),]
```

```{r populatie}
country_data %>% ggplot(aes(x=country, y=population))+
  geom_col()
```

```{r flu}
country_data %>% ggplot(aes(x=country, y=dengue))+
  geom_col()
```

```{r data analyse activity door jaar}
library(RColorBrewer)

#Summarise van data per year 
flu_dengue <- all_data %>% group_by(month, year) %>% 
  na.omit() %>% filter(year!=2002) %>% 
  summarise(mean(dengue_activity, na.rm=TRUE),mean(flu_activity, na.rm=TRUE))
colnames(flu_dengue) <- c("month","year","dengue_activity","flu_activity")

#Functie voor plot van verloop activity
activity_years_func <- function(dataset,activity){
  dataset %>% ggplot(aes(x=month,y=dataset[[activity]], group=year, color=factor(year)))+
  geom_line()+
  scale_x_continuous(name="Month", breaks=(1:12), limits=c(1, 12))+
  scale_color_brewer(palette = "Set1")+
  theme_minimal()
}
```

```{r}

activity_years_func(flu_dengue,"flu_activity")
```

```{r}

activity_years_func(flu_dengue,"dengue_activity")

```
